#!/bin/bash

# This script finds all __manifest__.py files in the current directory and
# attempts to parse them using Python's ast.literal_eval, which mimics
# how Odoo loads these files. It reports the path of any file that
# throws a SyntaxError or ValueError.

# Define the starting directory for the search (defaults to current directory)
START_DIR="${1:-.}"
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}=====================================================${NC}"
echo -e "${GREEN}ðŸ” Starting search for problematic __manifest__.py files...${NC}"
echo -e "${GREEN}Searching in: ${START_DIR}${NC}"
echo -e "${GREEN}=====================================================${NC}"

# Use 'find' to locate all manifest files and pipe them to a while loop
# '-type f' ensures we only check files, '-name' matches the manifest pattern
find "$START_DIR" -type f -name '__manifest__.py' | while IFS= read -r FILE_PATH; do
    
    # Run the Python check and capture both its output (for error details)
    # and its exit code.
    PYTHON_OUTPUT=$(python3 -c "
import ast
import sys
import os

try:
    with open('$FILE_PATH', 'r') as f:
        data = f.read()
    # Odoo strips whitespace before evaluation, matching the traceback context.
    ast.literal_eval(data.lstrip()) 
    # If successful, print OK and exit 0
    print('[ OK ]', end='')
except (SyntaxError, ValueError) as e:
    # If an error occurs, print the specific error message and exit 1
    print(f'[ FAILED ] {type(e).__name__}: {e}', file=sys.stderr)
    sys.exit(1)
" 2>&1)
    
    PYTHON_EXIT_CODE=$?
    
    if [ $PYTHON_EXIT_CODE -ne 0 ]; then
        
        # If the python command failed, print the file path and the error captured
        echo -e "\n${RED}=====================================================${NC}"
        echo -e "${RED}ðŸš¨ ERROR FOUND IN FILE:${NC}"
        echo -e "${YELLOW}$FILE_PATH${NC}"
        echo -e "${YELLOW}-----------------------------------------------------${NC}"
        echo -e "${RED}FAILURE DETAILS:${NC} ${PYTHON_OUTPUT}"
        echo -e "${RED}=====================================================${NC}\n"
        
        # Optionally, you can uncomment the 'break' line below to stop after the first error.
        # break 
    else
        # Print the success message captured from the Python script
        echo -e "${GREEN}${PYTHON_OUTPUT}${NC} $FILE_PATH"
    fi

done

echo -e "${GREEN}=====================================================${NC}"
echo "âœ… Manifest check complete."
echo -e "${GREEN}=====================================================${NC}"
